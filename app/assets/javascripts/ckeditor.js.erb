function toolbar_style(setting){
  if (setting == 'none'){
    return [];
  } else if (setting == 'brief') {
    return [
      // { name: 'styles', items: [ 'Format' ] },
      { name: 'basicStyles', items: ['Bold', 'Italic', 'Underline', 'Strike' ] },
      { name: 'paragraph', items: [ 'NumberedList', 'BulletedList' ] },
      { name: 'paragraph', items: [ 'Blockquote', 'Link' ] },
      { name: 'editing', items: [ 'PasteText', 'Scayt' ] }
    ];
  } else {
    return [
      { name: 'styles', items: [ 'Format' ] },
      { name: 'basicStyles', items: ['Bold', 'Italic', 'Underline', 'Strike' ] },
      { name: 'paragraph', items: [ 'NumberedList', 'BulletedList' ] },
      { name: 'paragraph', items: [ 'Blockquote', 'Link' ] },
      { name: 'editing', items: [ 'PasteText', 'Scayt' ] },
      { name: 'insert', items: [ 'Image', 'Table', 'HorizontalRule' ] },
      { name: 'tools', items: [ 'Maximize' ] }
      // Unused for now:
      // 'RemoveFormat'
      // { name: 'links', items: [ , 'Unlink' ] },
      // { name: 'document', items: [ 'Source' ] }
    ];
  }
}

// Arguments:
// - textarea - a Jquery selector with 1 textarea element. Must have a unique id.
function init_ckeditor(textarea){
  <%# DISABLE ckeditor in test mode, so feature tests are less awkward %>
  <% if Rails.env.test? %> return; <% end %>

  var id = textarea.attr('id');
  // For config, see:
  // - http://docs.ckeditor.com/#!/guide/dev_toolbarconcepts
  // - http://ckeditor.com/tmp/4.5.0-beta/ckeditor/samples/toolbarconfigurator/index.html#advanced
  CKEDITOR.replace(id, {
    toolbar: toolbar_style(textarea.data('toolbar')) // defaults to "full"
  });

  // Periodically fill the original textarea element with the updated content;
  // sadly ckeditor doesn't do this automatically.
  setInterval(function(){
    textarea.text( CKEDITOR.instances[id].getData() );
  }, 5000);
}

$(function(){
  // Init ckeditor for all elements present on page load
  // but the init function is available to call anywhere else too
  $('textarea.js-ckeditor').each(function(){
    init_ckeditor($(this));
  });

  // Default open links in a new tab
  // See http://docs.ckeditor.com/#!/guide/dev_howtos_dialog_windows
  // and http://handsomedogstudio.com/ckeditor-set-default-target-blank
  CKEDITOR.on('dialogDefinition', function(e) {
    try {
      var dialogName = e.data.name;
      var dialogDefinition = e.data.definition;
      if (dialogName == 'link') {
        var informationTab = dialogDefinition.getContents('target');
        var targetField = informationTab.get('linkTargetType');
        targetField['default'] = '_blank';
      }
    } catch(exception) {
      alert('Error ' + ev.message);
    }
  });
});
